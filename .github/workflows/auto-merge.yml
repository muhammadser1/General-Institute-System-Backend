name: Auto Merge to Develop

on:
  # Trigger when PR checks complete
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ develop ]  # Only auto-merge to develop
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    name: Auto Merge to Develop Branch
    runs-on: ubuntu-latest
    
    # Only auto-merge PRs targeting develop branch
    # NEVER auto-merge to main (main is manual only)
    if: |
      github.event.pull_request.base.ref == 'develop' &&
      github.event.pull_request.draft == false &&
      (
        contains(github.event.pull_request.labels.*.name, 'automerge') ||
        startsWith(github.event.pull_request.head.ref, 'dependabot/') ||
        startsWith(github.event.pull_request.head.ref, 'feature/') ||
        startsWith(github.event.pull_request.head.ref, 'bugfix/')
      )
    
    permissions:
      contents: write
      pull-requests: write
      checks: read
    
    steps:
    - name: üîç Wait for all checks to pass
      uses: lewagon/wait-on-check-action@v1.3.4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 10
        running-workflow-name: 'Auto Merge after Tests Pass'
        allowed-conclusions: success
    
    - name: ‚úÖ Auto-approve PR
      uses: hmarr/auto-approve-action@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üöÄ Enable auto-merge
      run: gh pr merge --auto --squash "$PR_NUMBER"
      env:
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
