name: Auto Merge to Develop

on:
  # Trigger ONLY when the test workflow completes successfully
  workflow_run:
    workflows: ["Tests and Code Quality"]
    types: [completed]
    branches: [develop]

jobs:
  auto-merge:
    name: Auto Merge to Develop Branch
    runs-on: ubuntu-latest
    
    # Only run if the test workflow succeeded
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'

    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
    
    - name: 🔍 Get PR number
      id: pr
      uses: actions/github-script@v7
      with:
        script: |
          const pulls = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
            state: 'open'
          });
          
          if (pulls.data.length === 0) {
            console.log('No open PR found for this branch');
            return null;
          }
          
          const pr = pulls.data[0];
          console.log(`Found PR #${pr.number}: ${pr.title}`);
          
          // Check if PR targets develop and matches our criteria
          if (pr.base.ref !== 'develop') {
            console.log('PR does not target develop branch');
            return null;
          }
          
          const headRef = context.payload.workflow_run.head_branch;
          if (!headRef.startsWith('feature/') && 
              !headRef.startsWith('bugfix/') && 
              !pr.labels.some(l => l.name === 'automerge')) {
            console.log('PR does not match auto-merge criteria');
            return null;
          }
          
          return pr.number;
    
    - name: 🚀 Enable auto-merge (squash)
      if: steps.pr.outputs.result != 'null'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.pr.outputs.result }}"
        echo "✅ Tests passed! Enabling auto-merge for PR #$PR_NUMBER"
        gh pr merge --auto --squash "$PR_NUMBER" --repo ${{ github.repository }}
        echo "🎉 Auto-merge enabled! PR will merge automatically."
