name: Auto Merge to Develop

on:
  # Trigger only when all checks (from other workflows) are completed
  check_suite:
    types: [completed]
  # Also when a PR is updated or ready
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [develop]

jobs:
  auto-merge:
    name: Auto Merge to Develop Branch
    runs-on: ubuntu-latest

    # Run only if:
    # - The PR targets 'develop'
    # - Itâ€™s not a draft
    # - All required checks have passed
    if: |
      github.event.pull_request &&
      github.event.pull_request.base.ref == 'develop' &&
      github.event.pull_request.draft == false &&
      (
        startsWith(github.event.pull_request.head.ref, 'feature/') ||
        startsWith(github.event.pull_request.head.ref, 'bugfix/') ||
        contains(github.event.pull_request.labels.*.name, 'automerge')
      )
      
    permissions:
        actions: read
        checks: read
        contents: write
        pull-requests: write


    steps:
    - name: ðŸ§  Wait for all required checks
      uses: lewagon/wait-on-check-action@v1.3.4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 10
        running-workflow-name: 'Tests and Code Quality'
        allowed-conclusions: success

    - name: ðŸš€ Enable auto-merge (squash)
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "All checks passed! Attempting to merge..."
        gh pr merge --auto --squash ${{ github.event.pull_request.number }} --repo ${{ github.repository }}
