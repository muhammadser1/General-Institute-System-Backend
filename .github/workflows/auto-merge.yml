name: Auto Merge to Develop

on:
  # Trigger when checks complete
  check_suite:
    types: [completed]
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ develop ]

jobs:
  auto-merge:
    name: Auto Merge to Develop Branch
    runs-on: ubuntu-latest
    
    # Only run after all checks complete successfully
    if: |
      github.event.pull_request &&
      github.event.pull_request.base.ref == 'develop' &&
      github.event.pull_request.draft == false &&
      (
        contains(github.event.pull_request.labels.*.name, 'automerge') ||
        startsWith(github.event.pull_request.head.ref, 'dependabot/') ||
        startsWith(github.event.pull_request.head.ref, 'feature/') ||
        startsWith(github.event.pull_request.head.ref, 'bugfix/')
      )
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: âœ… Auto-approve PR
      uses: hmarr/auto-approve-action@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸš€ Enable auto-merge (squash)
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr merge --auto --squash ${{ github.event.pull_request.number }} --repo ${{ github.repository }}
